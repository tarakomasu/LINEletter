# イルミネーションエフェクト仕様書

このドキュメントは、Fabric.jsキャンバス用の新しい視覚効果である「イルミネーション」エフェクトの技術仕様を概説します。

## 1. 概要

イルミネーションエフェクトは、お祭りの飾りのような点滅する光の連なりをシミュレートします。設定可能なモードは2つあります：「単色（モノクローム）」（ユーザー定義の単一色）と「虹（レインボー）」（事前定義された色のシーケンス）。電球の数と点滅速度は調整可能です。

実装は `src/lib/effects/illumination.ts` に配置され、既存の `sparkle.ts` エフェクトの構造に基づきます。

## 2. コアコンポーネント

### 2.1. Fabric.jsカスタムクラス: `IlluminationEffect`

- `fabric.Group` を拡張した `IlluminationEffect` という名前のカスタムクラスが作成されます。
- このクラスは、すべての電球オブジェクトをグループ化し、エフェクト全体のプロパティを管理します。
- 以下のようなカスタムプロパティが含まれます：
  - `effectType`: `'illumination-monochrome'` | `'illumination-rainbow'`
  - `bulbCount`: `number`
  - `blinkSpeed`: `number` (1回のON/OFFサイクルの持続時間、ミリ秒)
  - `color`: `string` (単色モードのみ)

### 2.2. 電球オブジェクトの構造

各「電球」は、視覚的に魅力的な輝く効果を生み出すために2つの `fabric.Circle` オブジェクトを含む `fabric.Group` になります。

- **外側カバー (`cover`):**
  - 電球の筐体として機能する、より大きな透明な円。非常に目立たないようにします。
- **内側コア (`luminousBody`):**
  - 光源を表す、より小さな色付きの円。
  - このオブジェクトは、点灯時に柔らかく「ロマンチックな」輝きを生み出すために `shadow` プロパティ（ガウスぼかしとして機能）を持ちます。影の色はコアの色と一致します。

## 3. 配置とレイアウト

- 電球は、自然に垂れ下がっているように見せるため、非常に長い波長の正弦波に沿って配置されます。
- **波長:** 波の1つの完全なサイクルの水平距離は、およそ `電球間の間隔 * 6` になります。
- **連続性:** `bulbCount` が変更された場合でも光の連なりが連続して見えるように、波のパターンは動的に計算される必要があります。
- エフェクトグループ全体は、ユーザーによって移動、拡大縮小、回転が可能です。電球の内部配置は比例して拡大縮小されるべきです。

## 4. アニメーション: 交互点滅

- 点滅アニメーションは中央の関数によって管理されます。
- 連なりの奇数番目と偶数番目の電球は交互に点滅します。
  - **フレーム1:** 奇数番目の電球（1、3、5、...）がON、偶数番目の電球（2、4、6、...）がOFF。
  - **フレーム2:** 奇数番目の電球がOFF、偶数番目の電球がON。
- `blinkSpeed` プロパティが各フレームの持続時間を制御します。
- **ON状態:** `luminousBody` が表示され、その輝く影が有効になります。
- **OFF状態:** `luminousBody` の不透明度が0に設定され、その影が無効になります。

## 5. カラーパターン

### 5.1. 単色モード

- グループ内のすべての `luminousBody` オブジェクトは同じ色になります。
- 色は `updateIlluminationColor` 関数を介してユーザーによって動的に更新できます。

### 5.2. 虹モード

- 電球は、事前定義された繰り返しの色のシーケンス（例：赤、オレンジ、黄、緑、青、藍、紫）に従います。
- このモードでは、ユーザーは色を変更できません。

## 6. 公開関数 (API)

`illumination.ts` から以下の関数がエクスポートされます：

- `createMonochromeIlluminationEffect(canvas: fabric.Canvas, options: { ... })`: キャンバスに新しい単色イルミネーションエフェクトを作成して追加します。
- `createRainbowIlluminationEffect(canvas: fabric.Canvas, options: { ... })`: キャンバスに新しい虹色イルミネーションエフェクトを作成して追加します。
- `updateIlluminationBulbCount(group: fabric.Group, newCount: number)`: `newCount` に一致するように電球を追加または削除し、波のパターンを維持します。
- `updateIlluminationBlinkSpeed(group: fabric.Group, newSpeed: number)`: アニメーションの点滅速度を更新します。
- `updateIlluminationColor(group: fabric.Group, newColor: string)`: すべての電球の色を更新します（単色モードのみ）。
- `resumeIlluminationAnimation(obj: fabric.Object, canvas: fabric.Canvas)`: JSONからロードされたエフェクトのアニメーションを再開します。

## 7. 初期状態

- **デフォルトの `bulbCount`:** 5。
- **作成:** UIは、ユーザーが「単色イルミネーション」または「虹イルミネーション」エフェクトを追加するための個別のオプションを提供します。